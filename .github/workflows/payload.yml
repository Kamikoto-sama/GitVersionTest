name: Do work

on:
  workflow_run:
    workflows: "Tag with SemVer"
    types:
      - completed

env:
  PATHS_REGEX: ^App2|payload.yml

jobs:
  get-diff:
    runs-on: ubuntu-latest
    outputs:
      diff: ${{ env.DIFF != '0' && env.DIFF || '' }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Get diff count
        run: echo "DIFF=$(git diff ${{ github.sha }} ${{ github.sha }}^ --name-only | grep -cE '${{ env.PATHS_REGEX }}')" >> $GITHUB_ENV
      - name: Print diff
        run: git diff ${{ github.sha }} ${{ github.sha }}^ --name-only | grep -cE '${{ env.PATHS_REGEX }}'

  get-tag:
    runs-on: ubuntu-latest
    needs: get-diff
    if: needs.get-diff.outputs.diff
    outputs:
      tag: ${{ env.TAG }}
    steps:
       - uses: actions/checkout@v3
         with:
            fetch-depth: 0
       - run: git tag --contains ${{ github.sha }}
       - name: Set tag to env
         run: echo "TAG=$(git tag --contains ${{ github.sha }})" >> $GITHUB_ENV

  do-work:
    runs-on: ubuntu-latest
    needs: get-tag
    if: needs.get-tag.outputs.tag != ''
    env:
      VER: ${{ needs.get-tag.outputs.tag }}
    steps:
    - name: Work
      run: echo $VER
       
